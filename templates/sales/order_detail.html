{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3>Sales Order SO/{{ so.pk }}</h3>
    <div>
      {% if so.status != 'confirmed' %}
        <a class="btn btn-success" href="{% url 'sales_order_confirm' so.pk %}">Confirm</a>
      {% else %}
        <span class="badge bg-success">Confirmed</span>
      {% endif %}
      <a class="btn btn-secondary" href="{% url 'sales_order_list' %}">Back</a>
      <a href="{% url 'create_invoice_from_so' so.pk %}" class="btn btn-primary">
        Create Invoice
      </a>
      
    </div>
  </div>

  <p><strong>Customer:</strong> {{ so.customer }}</p>
  <p><strong>Reference:</strong> {{ so.reference }}</p>
  <p><strong>Date:</strong> {{ so.date }}</p>

  <hr />

  <h5>Lines</h5>
  <table class="table table-dark table-sm">
    <thead>
      <tr><th>#</th><th>Product</th><th>Qty</th><th>Unit Price</th><th>Tax %</th><th>Tax Amt</th><th>Total</th></tr>
    </thead>
    <tbody>
      {% for line in so.lines.all %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ line.product }}</td>
        <td>{{ line.qty }}</td>
        <td>{{ line.unit_price }}</td>
        <td>{{ line.tax_percent }}</td>
        <td>{{ line.tax_amount }}</td>
        <td>{{ line.line_total }}</td>
      </tr>
      {% endfor %}
      {% if not so.lines.exists %}
      <tr><td colspan="7"><em>No lines yet. Add below.</em></td></tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="6" class="text-end">Net</th>
        <th>{{ total_net|floatformat:2 }}</th>
      </tr>
      <tr>
        <th colspan="6" class="text-end">Tax</th>
        <th>{{ total_tax|floatformat:2 }}</th>
      </tr>
      <tr>
        <th colspan="6" class="text-end">Total</th>
        <th>{{ total|floatformat:2 }}</th>
      </tr>
    </tfoot>
  </table>

  <hr />

  <h5>Add Line</h5>
  <form method="post" action="{% url 'sales_order_add_line' so.pk %}">
    {% csrf_token %}
    <div class="row g-2">
      <div class="col-md-5">
        <label>Product</label>
        <select name="product" class="form-select">
          <option value="">-- not linked --</option>
          {% for p in products %}
            <option value="{{ p.pk }}" data-price="{{ p.sale_price|default:0 }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label>Qty</label>
        <input name="qty" type="number" step="0.01" value="1" class="form-control" />
      </div>
      <div class="col-md-2">
        <label>Unit price</label>
        <input name="unit_price" type="number" step="0.01" value="0" class="form-control" />
      </div>
      <div class="col-md-2">
        <label>Tax %</label>
        <input name="tax_percent" type="number" step="0.01" value="0" class="form-control" />
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-primary w-100">Add</button>
      </div>
    </div>
  </form>

</div>

<script>
/* small UX: when product selected, auto-copy product price into unit_price if available */
document.addEventListener('DOMContentLoaded', function(){
  const prodSel = document.querySelector('select[name="product"]');
  const priceInput = document.querySelector('input[name="unit_price"]');
  if(prodSel && priceInput){
    prodSel.addEventListener('change', function(e){
      const opt = e.target.selectedOptions[0];
      if(opt && opt.dataset.price){
        priceInput.value = opt.dataset.price;
      }
    });
  }
});
</script>
{% endblock %}
