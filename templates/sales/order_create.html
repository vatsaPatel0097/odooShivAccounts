{% extends 'base.html' %}
{% block content %}
<div class="card p-4" style="max-width:1100px;">
  <h3>New Sales Order</h3>

  <form method="post" id="soForm">{% csrf_token %}
    <div class="mb-3">
      <label>Customer</label>
      <select name="customer" class="form-control" required>
        <option value="">-- select customer --</option>
        {% for c in contacts %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <label>SO Date</label>
        <input type="date" name="so_date" class="form-control" value="{{ today|default:None }}">
      </div>
      <div class="col-md-8">
        <label>Reference (optional)</label>
        <input type="text" name="reference" class="form-control" placeholder="Leave empty to auto-generate">
      </div>
    </div>

    <h5>Order Lines</h5>
    <table class="table table-bordered" id="linesTable">
      <thead class="table-light">
        <tr>
          <th style="width:36px">#</th>
          <th style="width:320px">Product</th>
          <th style="width:100px">Qty</th>
          <th style="width:120px">Unit Price</th>
          <th style="width:100px">Tax %</th>
          <th style="width:120px">Untaxed</th>
          <th style="width:120px">Tax Amt</th>
          <th style="width:120px">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for i in "12345" %}
        <tr data-line="{{ forloop.counter }}">
          <td class="align-middle">{{ forloop.counter }}</td>

          <td>
            <select name="product_{{ forloop.counter }}" class="form-control product-select">
              <option value="">--select--</option>
              {% for p in products %}
                <option value="{{ p.id }}">{{ p.name }}{% if p.hsn %} ({{ p.hsn }}){% endif %}</option>
              {% endfor %}
            </select>
          </td>

          <td>
            <input type="number" min="0" step="1" name="qty_{{ forloop.counter }}" value="1" class="form-control qty" />
          </td>

          <td>
            <input type="number" step="0.01" name="unit_price_{{ forloop.counter }}" class="form-control unit-price" />
          </td>

          <td>
            <input type="number" step="0.01" name="tax_percent_{{ forloop.counter }}" class="form-control tax-percent" />
          </td>

          <td>
            <input type="text" class="form-control untaxed" readonly />
          </td>

          <td>
            <input type="text" class="form-control tax-amt" readonly />
          </td>

          <td>
            <input type="text" class="form-control line-total" readonly />
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" class="text-end fw-bold">Subtotals:</td>
          <td><input type="text" id="subtotal_untaxed" name="subtotal_untaxed" class="form-control" readonly /></td>
          <td><input type="text" id="subtotal_tax" name="subtotal_tax" class="form-control" readonly /></td>
          <td><input type="text" id="subtotal_total" name="subtotal_total" class="form-control" readonly /></td>
        </tr>
      </tfoot>
    </table>

    <div class="mt-3">
      <button class="btn btn-success" id="createBtn">Create SO</button>
      <a class="btn btn-secondary" href="{% url 'sales_order_list' %}">Back</a>
    </div>
  </form>
</div>

<script>
(function(){
  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  function toFloat(v){ v = v || '0'; v = v.toString().replace(/,/g,''); return parseFloat(v) || 0; }
  function fmt(n){ return (parseFloat(n)||0).toFixed(2); }

  function fetchProductInfo(pid, cb){
    if(!pid){ cb && cb(null); return; }
    fetch(`/products/info/${pid}/`).then(r=>{
      if(!r.ok) return cb && cb(null);
      return r.json();
    }).then(json=>{ cb && cb(json); })
    .catch(e=>{ console.warn('product info error', e); cb && cb(null); });
  }

  function updateRow(row){
    let qty = toFloat(row.querySelector('.qty').value);
    let price = toFloat(row.querySelector('.unit-price').value);
    let taxp = toFloat(row.querySelector('.tax-percent').value);

    let untaxed = qty * price;
    let taxamt = untaxed * taxp / 100.0;
    let total = untaxed + taxamt;

    row.querySelector('.untaxed').value = fmt(untaxed);
    row.querySelector('.tax-amt').value = fmt(taxamt);
    row.querySelector('.line-total').value = fmt(total);
  }

  function recalcAll(){
    let u=0, t=0, g=0;
    $all('tr[data-line]').forEach(row=>{
      updateRow(row);
      u += toFloat(row.querySelector('.untaxed').value);
      t += toFloat(row.querySelector('.tax-amt').value);
      g += toFloat(row.querySelector('.line-total').value);
    });
    $('#subtotal_untaxed').value = fmt(u);
    $('#subtotal_tax').value = fmt(t);
    $('#subtotal_total').value = fmt(g);
  }

  $all('.product-select').forEach(sel=>{
    sel.addEventListener('change', function(){
      let row = sel.closest('tr');
      let pid = sel.value;
      if(!pid){
        row.querySelector('.unit-price').value = '';
        row.querySelector('.tax-percent').value = '';
        recalcAll();
        return;
      }
      fetchProductInfo(pid, function(data){
        if(!data){ recalcAll(); return; }
        if('sale_price' in data) row.querySelector('.unit-price').value = data.sale_price;
        if('sale_tax' in data) row.querySelector('.tax-percent').value = data.sale_tax;
        recalcAll();
      });
    });
  });

  $all('.qty, .unit-price, .tax-percent').forEach(inp=>{
    inp.addEventListener('input', recalcAll);
  });

  document.addEventListener('DOMContentLoaded', recalcAll);

  $('#soForm').addEventListener('submit', function(ev){
    recalcAll();
    const cust = this.querySelector('[name="customer"]').value;
    if(!cust){ ev.preventDefault(); alert('Select a customer.'); return; }
    let ok=false;
    $all('.product-select').forEach(s=>{ if(s.value) ok=true; });
    if(!ok){ ev.preventDefault(); alert('Please select at least one product.'); return; }
  });
})();
</script>
{% endblock %}
