  {% extends 'base.html' %}
  {% block content %}
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Product Master</h4>
      <a href="{% url 'products_add' %}" class="btn btn-primary">New</a>
    </div>

    <table class="table table-dark table-sm">
      <thead>
        <tr>
          <th></th>
          <th>Name</th>
          <th>Type</th>
          <th>Sales Price</th>
          <th>Purchase Price</th>
          <th>HSN</th>
          <th>Sale Tax</th>
          <th>Purchase Tax</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
          <tr>
            <td style="width:50px;">
              {% if product.image %}
                {% if product.image.url %}
                  <img src="{{ product.image.url }}" style="height:36px;width:36px;border-radius:6px;">
                {% else %}
                  -
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>

            <td>{{ product.name|default:"-" }}</td>
            <td>{{ product.product_type|title }}</td>

            <td>
              {% if product.sales_price is not None %}
                {{ product.sales_price }}
              {% else %}
                -
              {% endif %}
            </td>

            <td>
              {% if product.purchase_price is not None %}
                {{ product.purchase_price }}
              {% else %}
                -
              {% endif %}
            </td>

            <td>{{ product.hsn|default:"-" }}</td>

            <td>
              {% if product.sale_tax %}
                {{ product.sale_tax.name }} {% if product.sale_tax.value %} ({{ product.sale_tax.value }}{% if product.sale_tax.computation == 'percent' %}%{% endif %}){% endif %}
              {% else %}
                -
              {% endif %}
            </td>

            <td>
              {% if product.purchase_tax %}
                {{ product.purchase_tax.name }} {% if product.purchase_tax.value %} ({{ product.purchase_tax.value }}{% if product.purchase_tax.computation == 'percent' %}%{% endif %}){% endif %}
              {% else %}
                -
              {% endif %}
            </td>

            <td>
              {% comment %}
                Show "Open" to everyone, but Edit/Delete only to admins.
                We check both `user.role` (your custom user object) and
                `request.user.is_staff` (Django auth) so it works in either setup.
              {% endcomment %}
            
              <a class="btn btn-sm btn-outline-light" href="{% url 'products_detail' product.id %}">Open</a>
            
              {% if user and user.role == 'admin' %}
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'products_edit' product.id %}">Edit</a>
                <form method="post" action="{% url 'products_delete' product.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this product?');">Delete</button>
                </form>
              {% elif request.user.is_authenticated and request.user.is_staff %}
                {# fallback if you use Django auth - staff users are treated as admin #}
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'products_edit' product.id %}">Edit</a>
                <form method="post" action="{% url 'products_delete' product.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this product?');">Delete</button>
                </form>
              {% endif %}
            </td>
            
          </tr>
        {% empty %}
          <tr><td colspan="9">No products found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mt-3">
      {% if products.has_other_pages %}
        <nav>
          <ul class="pagination">
            {% if products.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ products.previous_page_number }}">Prev</a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ products.number }} / {{ products.paginator.num_pages }}</span></li>
            {% if products.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ products.next_page_number }}">Next</a></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>

  </div>
  {% endblock %}
