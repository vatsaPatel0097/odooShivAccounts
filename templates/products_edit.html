{% extends 'base.html' %}
{% block content %}
<div class="card p-4" style="max-width:920px">
  <h4>Edit Product</h4>
  <form method="post" enctype="multipart/form-data">{% csrf_token %}
    <div class="row">
      <div class="col-md-6 mb-2">
        <label>Name</label>
        <input name="name" id="prod-name" class="form-control" value="{{ product.name }}" />
      </div>

      <div class="col-md-6 mb-2">
        <label>Type</label>
        <select name="product_type" class="form-control">
          <option value="goods" {% if product.product_type == 'goods' %}selected{% endif %}>Goods</option>
          <option value="service" {% if product.product_type == 'service' %}selected{% endif %}>Service</option>
        </select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Sales Price</label>
        <input type="number" step="0.01" name="sales_price" class="form-control" value="{{ product.sales_price }}"/>
      </div>
      <div class="col-md-6 mb-2">
        <label>Purchase Price</label>
        <input type="number" step="0.01" name="purchase_price" class="form-control" value="{{ product.purchase_price }}"/>
      </div>

      <div class="col-md-6 mb-2">
        <label>HSN / SAC Code</label>
        <div class="hsn-field-wrap">
          <input name="hsn" id="hsn-input" class="form-control" autocomplete="off" value="{{ product.hsn }}" />
          <div id="hsn-suggestions" class="hsn-suggestions" style="display:none;"></div>
        </div>
      </div>

      <div class="col-md-6 mb-2">
        <label>Category</label>
        <input name="category" class="form-control" value="{{ product.category }}"/>
      </div>

      <div class="col-md-6 mb-2">
        <label>Sales Tax (from local Tax Master)</label>
        <select name="sale_tax_id" id="sale-tax-select" class="form-control">
          <option value="">-- Select --</option>
          {% for tax in taxes %}
            <option value="{{ tax.id }}" {% if product.sale_tax and product.sale_tax.id == tax.id %}selected{% endif %}>
              {{ tax.name }} — {{ tax.value }}{% if tax.computation == 'percent' %}%{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Purchase Tax (from local Tax Master)</label>
        <select name="purchase_tax_id" id="purchase-tax-select" class="form-control">
          <option value="">-- Select --</option>
          {% for tax in taxes %}
            <option value="{{ tax.id }}" {% if product.purchase_tax and product.purchase_tax.id == tax.id %}selected{% endif %}>
              {{ tax.name }} — {{ tax.value }}{% if tax.computation == 'percent' %}%{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Image</label>
        <input type="file" name="image" class="form-control" />
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-primary">Save</button>
      <a class="btn btn-secondary" href="{% url 'products_list' %}">Back</a>
    </div>
  </form>
</div>

<style>
.hsn-suggestions { position: absolute; z-index: 40; background:#0b0c0d; border:1px solid #333; max-height:260px; overflow:auto; width:100%; }
.hsn-suggestions .item{ padding:8px; cursor:pointer; border-bottom:1px solid #222; color:#ddd; }
.hsn-suggestions .item:hover{ background:#222; }
.hsn-field-wrap{ position:relative; }
</style>

<script>
(function(){
  const hsnInput = document.getElementById('hsn-input');
  const sugg = document.getElementById('hsn-suggestions');
  const nameInput = document.getElementById('prod-name');

  function clearSuggestions(){ sugg.style.display='none'; sugg.innerHTML=''; }

  hsnInput.addEventListener('input', function(e){
    const q = e.target.value.trim();
    if (!q) { clearSuggestions(); return; }
    fetch(`/ajax/gst_hsn_lookup/?q=${encodeURIComponent(q)}`)
      .then(r => r.json())
      .then(data => {
        const list = data.results || [];
        if (!list.length) { clearSuggestions(); return; }
        sugg.innerHTML = list.map(it => {
          const desc = (it.description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div class="item" data-hsn="${it.hsn}" data-desc="${desc}">${it.hsn} — ${desc}</div>`;
        }).join('');
        sugg.style.display = 'block';
        sugg.querySelectorAll('.item').forEach(el => el.addEventListener('click', ()=>{
          const code = el.dataset.hsn;
          const desc = el.dataset.desc || '';
          hsnInput.value = code;
          if (nameInput && nameInput.value.trim()==='') nameInput.value = desc;
          clearSuggestions();
        }));
      }).catch(err => {
        console.error('gst_hsn_lookup error', err);
        clearSuggestions();
      });
  });

  document.addEventListener('click', function(ev){
    if (!ev.target.closest('.hsn-field-wrap')) clearSuggestions();
  });

  // safety: ensure selects remain selects
  window.addEventListener('DOMContentLoaded', () => {
    const sale = document.getElementById('sale-tax-select');
    const pur = document.getElementById('purchase-tax-select');
    if (!sale || sale.tagName.toLowerCase() !== 'select') console.warn('sale-tax-select missing or not a <select>');
    if (!pur || pur.tagName.toLowerCase() !== 'select') console.warn('purchase-tax-select missing or not a <select>');
  });
})();
</script>
{% endblock %}
