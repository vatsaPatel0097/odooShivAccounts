{% extends 'base.html' %}
{% block content %}
<div class="card p-4" style="max-width:820px">
  <h4>Edit Product</h4>
  <form method="post" enctype="multipart/form-data">{% csrf_token %}
    <div class="row">
      <div class="col-md-6 mb-2"><label>Name</label><input name="name" class="form-control" value="{{ product.name }}" required/></div>
      <div class="col-md-6 mb-2">
        <label>Type</label>
        <select name="product_type" class="form-control">
          <option value="goods" {% if product.product_type == "goods" %}selected{% endif %}>Goods</option>
          <option value="service" {% if product.product_type == "service" %}selected{% endif %}>Service</option>
        </select>
      </div>

      <div class="col-md-6 mb-2"><label>Sales Price</label><input type="number" step="0.01" name="sales_price" class="form-control" value="{{ product.sales_price }}"/></div>
      <div class="col-md-6 mb-2"><label>Sales Tax %</label><input type="number" step="0.01" name="sale_tax_percent" class="form-control" value="{{ product.sale_tax_percent }}"/></div>

      <div class="col-md-6 mb-2"><label>Purchase Price</label><input type="number" step="0.01" name="purchase_price" class="form-control" value="{{ product.purchase_price }}"/></div>
      <div class="col-md-6 mb-2"><label>Purchase Tax %</label><input type="number" step="0.01" name="purchase_tax_percent" class="form-control" value="{{ product.purchase_tax_percent }}"/></div>

      <div class="col-md-6 mb-2">
        <label>HSN / SAC Code</label>
        <div class="hsn-field-wrap">
          <input name="hsn" class="form-control" autocomplete="off" value="{{ product.hsn }}" placeholder="Type HSN code or description..." />
          <div id="hsn-suggestions" class="hsn-suggestions" style="display:none;"></div>
        </div>
      </div>

      <div class="col-md-6 mb-2"><label>Category</label><input name="category" class="form-control" value="{{ product.category }}"/></div>

      <div class="col-md-6 mb-2">
        <label>Image</label>
        {% if product.image %}
          <div class="mb-2"><img src="{{ product.image.url }}" style="height:80px;width:80px;border-radius:6px"></div>
        {% endif %}
        <input type="file" name="image" class="form-control"/>
      </div>
    </div>

    <div class="mt-3"><button class="btn btn-primary">Save</button> <a class="btn btn-secondary" href="{% url 'products_detail' product.id %}">Cancel</a></div>
  </form>
</div>

{# === HSN suggestions CSS + JS === #}
<style>
.hsn-suggestions { position: absolute; z-index: 40; background:#0b0c0d; border:1px solid #333; max-height:220px; overflow:auto; width:100%; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
.hsn-suggestions .item{ padding:8px; cursor:pointer; border-bottom:1px solid #222; color:#ddd; }
.hsn-suggestions .item:hover{ background:#222; }
.hsn-field-wrap{ position:relative; }
</style>

<script>
  (function(){
    const hsnInput = document.querySelector('input[name="hsn"]');
    const sugg = document.getElementById('hsn-suggestions');
  
    // fields to auto-fill (adjust selectors to match your template)
    const nameInput = document.querySelector('input[name="name"]');
    const salesPriceInput = document.querySelector('input[name="sales_price"]');
    const saleTaxInput = document.querySelector('input[name="sale_tax_percent"]');
    const purchasePriceInput = document.querySelector('input[name="purchase_price"]');
    const purchaseTaxInput = document.querySelector('input[name="purchase_tax_percent"]');
    const categoryInput = document.querySelector('input[name="category"]');
  
    function confirmOverwrite(callback){
      // if any of the fields already has a value, confirm
      const hasData = (nameInput.value || salesPriceInput.value || purchasePriceInput.value || categoryInput.value);
      if (!hasData){
        return callback(true);
      }
      // simple confirm dialog (you can replace with a nicer modal)
      const ok = confirm('Some product fields are already filled. Overwrite with master data?');
      callback(ok);
    }
  
    function fillProductData(data){
      // set fields only if user confirmed (handled by caller)
      nameInput.value = data.name || nameInput.value;
      if (salesPriceInput) salesPriceInput.value = data.sales_price || salesPriceInput.value;
      if (saleTaxInput) saleTaxInput.value = data.sale_tax_percent || saleTaxInput.value;
      if (purchasePriceInput) purchasePriceInput.value = data.purchase_price || purchasePriceInput.value;
      if (purchaseTaxInput) purchaseTaxInput.value = data.purchase_tax_percent || purchaseTaxInput.value;
      if (categoryInput) categoryInput.value = data.category || categoryInput.value;
      // optionally show image preview if you have an <img id="product-image-preview">
      const img = document.getElementById('product-image-preview');
      if (img && data.image_url) { img.src = data.image_url; img.style.display = 'inline-block'; }
    }
  
    if (!hsnInput || !sugg) return;
    let timer = null;
    hsnInput.addEventListener('input', (e)=>{
      clearTimeout(timer);
      const q = e.target.value.trim();
      if (!q) { sugg.style.display='none'; sugg.innerHTML=''; return; }
      timer = setTimeout(()=>{
        fetch(`/ajax/hsn_lookup/?q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data=>{
            if (!data.results || data.results.length === 0) { sugg.style.display='none'; sugg.innerHTML=''; return; }
            sugg.innerHTML = data.results.map(it => `<div class="item" data-hsn="${it.hsn}">${it.hsn} — ${it.description}</div>`).join('');
            sugg.style.display='block';
  
            sugg.querySelectorAll('.item').forEach(el => el.addEventListener('click', ()=>{
              const chosenHSN = el.dataset.hsn;
              hsnInput.value = chosenHSN;
              sugg.innerHTML=''; sugg.style.display='none';
  
              // now request product master for that HSN
              fetch(`/ajax/products_by_hsn/?hsn=${encodeURIComponent(chosenHSN)}`)
                .then(r => r.json())
                .then(res => {
                  const prods = res.results || [];
                  if (prods.length === 0){
                    // no product in master for this HSN — nothing to prefill
                    return;
                  } else if (prods.length === 1){
                    // single product — ask confirm overwrite if needed
                    confirmOverwrite(function(ok){
                      if (ok) fillProductData(prods[0]);
                    });
                  } else {
                    // multiple products found for same HSN — show a choose list
                    const choice = prompt('Multiple products found for this HSN. Type the product name to select or Cancel to skip.\\n' + prods.map((p,i)=>`${i+1}. ${p.name}`).join('\\n'));
                    if (!choice) return;
                    // try to match by index or substring
                    let selected = null;
                    const idx = parseInt(choice,10);
                    if (!isNaN(idx) && idx>=1 && idx<=prods.length) selected = prods[idx-1];
                    else {
                      selected = prods.find(p => p.name.toLowerCase().includes(choice.toLowerCase()));
                    }
                    if (selected){
                      confirmOverwrite(function(ok){ if (ok) fillProductData(selected); });
                    }
                  }
                })
                .catch(()=>{/* ignore errors */});
            }));
          })
          .catch(()=>{ sugg.style.display='none'; });
      }, 220);
    });
  
    // hide on click outside
    document.addEventListener('click', (ev)=>{
      if (!ev.target.closest('.hsn-field-wrap')) { sugg.style.display='none'; }
    });
  })();
  </script>
  
{% endblock %}
