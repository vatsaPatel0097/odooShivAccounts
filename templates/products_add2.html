{% extends 'base.html' %}
{% block content %}
<div class="card p-4" style="max-width:920px">
  <h4>New Product</h4>
  <form method="post" enctype="multipart/form-data">{% csrf_token %}
    <div class="row">
      <div class="col-md-6 mb-2">
        <label>Name</label>
        <input name="name" class="form-control" required/>
      </div>

      <div class="col-md-6 mb-2">
        <label>Type</label>
        <select name="product_type" class="form-control">
          <option value="goods">Goods</option>
          <option value="service">Service</option>
        </select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Sales Price</label>
        <input type="number" step="0.01" name="sales_price" class="form-control"/>
      </div>
      <div class="col-md-6 mb-2">
        <label>Purchase Price</label>
        <input type="number" step="0.01" name="purchase_price" class="form-control"/>
      </div>

      <div class="col-md-6 mb-2">
        <label>HSN / SAC Code</label>
        <div class="hsn-field-wrap">
          <input name="hsn" class="form-control" autocomplete="off" placeholder="Type HSN code..." />
          <div id="hsn-suggestions" class="hsn-suggestions" style="display:none;"></div>
        </div>
      </div>

      <div class="col-md-6 mb-2">
        <label>Category</label>
        <input name="category" class="form-control"/>
      </div>

      <div class="col-md-6 mb-2">
        <label>Sales Tax</label>
        <select name="sale_tax_id" class="form-control">
          <option value="">-- Select --</option>
          {% for tax in taxes %}
            <option value="{{ tax.id }}">{{ tax.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6 mb-2">
        <label>Purchase Tax</label>
        <select name="purchase_tax_id" class="form-control">
          <option value="">-- Select --</option>
          {% for tax in taxes %}
            <option value="{{ tax.id }}">{{ tax.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Image</label>
        <input type="file" name="image" class="form-control" />
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-primary">Create</button>
      <a class="btn btn-secondary" href="{% url 'products_list' %}">Back</a>
    </div>
  </form>
</div>

<style>
.hsn-suggestions { position: absolute; z-index: 40; background:#0b0c0d; border:1px solid #333; max-height:260px; overflow:auto; width:100%; }
.hsn-suggestions .item{ padding:8px; cursor:pointer; border-bottom:1px solid #222; color:#ddd; }
.hsn-suggestions .item:hover{ background:#222; }
.hsn-field-wrap{ position:relative; }
</style>

<script>
  (function(){
    const hsnInput = document.querySelector('input[name="hsn"]');
    const sugg = document.getElementById('hsn-suggestions');
    const nameInput = document.querySelector('input[name="name"]');
    const saleTaxSelect = document.querySelector('select[name="sale_tax_id"]');
    const purchaseTaxSelect = document.querySelector('select[name="purchase_tax_id"]');
  
    function setTaxSelect(selectElem, tax_id, rate_or_name){
      if(!selectElem) return;
      let opt = selectElem.querySelector('option[value="'+tax_id+'"]');
      if (!opt) {
        opt = document.createElement('option');
        opt.value = tax_id;
        opt.text = rate_or_name || ('GST ' + tax_id);
        selectElem.appendChild(opt);
      }
      selectElem.value = tax_id;
    }
  
    hsnInput.addEventListener('input', function(e){
      const q = e.target.value.trim();
      if (!q) { sugg.style.display='none'; sugg.innerHTML=''; return; }
      fetch(`/ajax/gst_hsn_lookup/?q=${encodeURIComponent(q)}`)
        .then(r=>r.json())
        .then(data=>{
          const list = data.results || [];
          if (!list.length) { sugg.style.display='none'; sugg.innerHTML=''; return; }
          sugg.innerHTML = list.map(it => `<div class="item" data-hsn="${it.hsn}" data-desc="${(it.description||'').replace(/"/g,'&quot;')}">${it.hsn} — ${it.description||''}</div>`).join('');
          sugg.style.display='block';
          sugg.querySelectorAll('.item').forEach(el => el.addEventListener('click', ()=>{
            const code = el.dataset.hsn;
            hsnInput.value = code;
            if (nameInput && el.dataset.desc && nameInput.value.trim()==="") nameInput.value = el.dataset.desc;
            sugg.innerHTML=''; sugg.style.display='none';
            // Call tax API (server will try remote then fallback to local)
            fetch(`/ajax/create_tax_from_hsn/?hsn=${encodeURIComponent(code)}`)
              .then(r=>r.json())
              .then(j=>{
                console.log('create_tax_from_hsn =>', j);
                if (j.ok) {
                  // j.name contains name like "GST 18%"
                  setTaxSelect(saleTaxSelect, j.tax_id, j.name);
                  setTaxSelect(purchaseTaxSelect, j.tax_id, j.name);
                  // optionally show a small toast or inline message:
                  // showMessage(`Tax ${j.name} selected (from ${j.source})`);
                } else {
                  console.warn('Tax API error', j.error, j.debug);
                  // optionally, you can show a small alert to user
                }
              }).catch(err=>{
                console.error('ajax error', err);
              });
          }));
        }).catch(err=>{
          console.error('gst_hsn_lookup error', err);
        });
    });
  })();
  </script>
{% endblock %}  

{% comment %} <script>
  (function(){
    const hsnInput = document.querySelector('input[name="hsn"]');
    const sugg = document.getElementById('hsn-suggestions');
    const nameInput = document.querySelector('input[name="name"]');
    const saleTaxSelect = document.querySelector('select[name="sale_tax_id"]');
    const purchaseTaxSelect = document.querySelector('select[name="purchase_tax_id"]');
  
    function setTax(select, tax_id, label){
      if(!select) return;
      let opt = select.querySelector(`option[value="${tax_id}"]`);
      if(!opt){
        opt = document.createElement("option");
        opt.value = tax_id;
        opt.textContent = label;
        select.appendChild(opt);
      }
      select.value = tax_id;
    }
  
    hsnInput.addEventListener("input", function(e){
      const q = e.target.value.trim();
      if(!q){ sugg.style.display="none"; return; }
      fetch(`/ajax/gst_hsn_lookup/?q=${encodeURIComponent(q)}`)
        .then(r=>r.json())
        .then(data=>{
          const list = data.results || [];
          if(!list.length){ sugg.style.display="none"; return; }
          sugg.innerHTML = list.map(it => `<div class="item" data-hsn="${it.hsn}" data-desc="${it.description||''}">${it.hsn} — ${it.description||''}</div>`).join('');
          sugg.style.display="block";
          sugg.querySelectorAll(".item").forEach(el=>{
            el.addEventListener("click", ()=>{
              const code = el.dataset.hsn;
              hsnInput.value = code;
              if(el.dataset.desc && nameInput.value==="") nameInput.value = el.dataset.desc;
              sugg.innerHTML=""; sugg.style.display="none";
              fetch(`/ajax/create_tax_from_hsn/?hsn=${encodeURIComponent(code)}`)
                .then(r=>r.json())
                .then(j=>{
                  if(j.ok){
                    setTax(saleTaxSelect, j.tax_id, j.name);
                    setTax(purchaseTaxSelect, j.tax_id, j.name);
                  }
                });
            });
          });
        });
    });
  })();
  </script>
{% endblock %} {% endcomment %}


{% comment %} <script>
(function(){
  const hsnInput = document.querySelector('input[name="hsn"]');
  const sugg = document.getElementById('hsn-suggestions');
  const nameInput = document.querySelector('input[name="name"]');
  const saleTaxSelect = document.querySelector('select[name="sale_tax_id"]');
  const purchaseTaxSelect = document.querySelector('select[name="purchase_tax_id"]');

  function setTaxSelect(selectElem, tax_id, rate, name){
    if(!selectElem) return;
    let opt = selectElem.querySelector('option[value="'+tax_id+'"]');
    if (!opt) {
      opt = document.createElement('option');
      opt.value = tax_id;
      opt.text = name;
      selectElem.appendChild(opt);
    }
    selectElem.value = tax_id;
  }

  hsnInput.addEventListener('input', function(e){
    const q = e.target.value.trim();
    if (!q) { sugg.style.display='none'; sugg.innerHTML=''; return; }
    fetch(`/ajax/gst_hsn_lookup/?q=${encodeURIComponent(q)}`)
      .then(r=>r.json())
      .then(data=>{
        const list = data.results || [];
        if (!list.length) { sugg.style.display='none'; sugg.innerHTML=''; return; }
        sugg.innerHTML = list.map(it => `<div class="item" data-hsn="${it.hsn}" data-desc="${it.description||''}">${it.hsn} — ${it.description||''}</div>`).join('');
        sugg.style.display='block';
        sugg.querySelectorAll('.item').forEach(el => el.addEventListener('click', ()=>{
          const code = el.dataset.hsn;
          hsnInput.value = code;
          if (nameInput && el.dataset.desc) nameInput.value = el.dataset.desc;
          sugg.innerHTML=''; sugg.style.display='none';
          // Call tax API
          fetch(`/ajax/create_tax_from_hsn/?hsn=${encodeURIComponent(code)}`)
            .then(r=>r.json())
            .then(j=>{
              if (j.ok) {
                setTaxSelect(saleTaxSelect, j.tax_id, j.rate, j.name);
                setTaxSelect(purchaseTaxSelect, j.tax_id, j.rate, j.name);
              } else {
                console.warn('Tax API error', j.error);
              }
            });
        }));
      });
  });
})();
</script>
{% endblock %}  {% endcomment %}
